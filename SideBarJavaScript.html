<script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
  var column, pdfcell;
  var $column, $pdfcell;

  /**
   * Run initializations on sidebar load.
   */
  $(function () {
    $row = $('#row');
    $row.change(onRowChange);
    row = Number($row.val());
    dropDownPopulate("data-sheet-dropdown");
    dropDownPopulate("pdf-sheet-dropdown");
    onRefreshBindingsClick();
    onRefreshFolderProp();
    var generatePDFRunner = google.script.run
        .withSuccessHandler(
          function (pdf) {
            // Respond to success conditions here.
            console.log(pdf);
            pdfDict = JSON.parse(pdf);
            $('#sidebar-generation-status').html("Success: <a href='" + pdfDict["pdfUrl"] + "'target=_blank rel=noopener noreferrer> " + pdfDict["pdfName"] + "</a>" + " generated");
            $('#sidebar-generate-pdf-button').prop('disabled', false);
          })
        .withFailureHandler(
          function (error) {
            // Respond to failure conditions here.
            $('#sidebar-generation-status').html("ERROR: " + error);
            $('#sidebar-generate-pdf-button').prop('disabled', false);
          })
    
    $('#sidebar-generate-pdf-button').click(async function () {

      $('#sidebar-generate-pdf-button').prop('disabled', true);
      settings = getSettingsFromHTML();
      generatePDFRunner.onSubmitSheetClick(settings);
      generatePDFRunner.generateResultingPDF(row);

    });
    $('#choose-folder-button').click(function () {
      google.script.run.showPicker();
    });
    $('#refresh-folder').click(onRefreshFolderProp);
    $('#sidebar-add-binding-button').click(onSubmitClick);
    /*$('#sidebar-update-settings-button').click(async function () {
      $('#sidebar-update-settings-button').prop('disabled', true);
      google.script.run
        .withSuccessHandler(function () {
          showAddSheetStatus('Successfully updated', 'success');
          $('#sidebar-update-settings-button').prop('disabled', false);
        })
        .withFailureHandler(function (error) {
          showAddSheetStatus(error, 'error');
          $('#sidebar-update-settings-button').prop('disabled', false);
        })
        .onSubmitSheetClick(getSettingsFromHTML());
    }

    );*/

    $('#sidebar-refresh-bindings-button').click(onRefreshBindingsClick);
    $("#active-bindings").on("click", ".delete-binding", function () {
      //alert("button pressed")
      google.script.run
        .withSuccessHandler(onRefreshBindingsClick())
        .withFailureHandler(alert('all-bindings-table-button click() yielded an error: ' + e))
        .deleteSingleProperty($(this).attr('id'));
    });
    $('#send-email-check').change(emailInfoVisibilityCheck)
    emailInfoVisibilityCheck();

  })

  function onRowChange() {
    row = Number(this.value);
    //updateResultingSize();
  }
  function onRefreshFolderProp() {
    folder_prop = google.script.run
      .withSuccessHandler(
        function (folder_prop) {
          if (folder_prop != null) {
            $('#folder-name-info').html("<a href='" + folder_prop["url"] + "'>" + folder_prop["name"] + "</a>");
          }
        }
      )
      .withFailureHandler(
        function (folder_prop) {
          // Respond to failure conditions here.
          alert('Problem during refresh of file properties.');
        })
      .getFolderProperty();

  }
  function onRefreshBindingsClick() {
    //this.disabled = true;
    google.script.run
      .withSuccessHandler(
        function (properties) {
          html = "<table id='all-bindings-table'>  <tr> <th></th><th>Column</th> <th>Cell</th></tr>";
          for (key in properties) {
            if (!isNaN(parseInt(key))) {
              property = JSON.parse(properties[key])
              html += "<tr> <td><i class='material-symbols-outlined delete-binding' id=" + key + ">delete_forever</i></td><td>" + property["column"] + "</td><td>" + property["cell"] + "</td></tr>";
            }
          }
          html += "</table>";

          try {
            $('#active-bindings').html(html);
            //showRefreshStatus('Successfully refreshed bindings',  'success');
          } catch (e) {
            alert('myFunction() yielded an error: ' + e);
          }

        }
      )
      .withFailureHandler(
        function (properties) {
          // Respond to failure conditions here.

          alert('Problem during refresh.');

          showRefreshStatus(msg, 'error');

        })
      .readProperties();
  }
  function onSubmitClick() {
    $column = $('#sidebar-column');
    column = $column.val();

    $pdfcell = $('#sidebar-pdfcell');
    pdfcell = $pdfcell.val();

    // Send the value to the server and handle the response.
    google.script.run
      .withSuccessHandler(
        function (msg, element) {
          // Respond to success conditions here.
          showAddStatus('Successfully added Col ' + column + ' for pdf cell ' + pdfcell, 'success');
        })
      .withFailureHandler(
        function (msg, element) {
          // Respond to failure conditions here.
          showAddStatus(msg, 'error');
        })
      .withUserObject(this)
      .setProperties(column = column, cell = pdfcell);
    onRefreshBindingsClick()
  }


  /**
   * Displays the given status message in the sidebar.
   *
   * @param {String} msg The status message to display.
   * @param {String} classId The message type (class id) that the message
   *   should be displayed as.
   */
  function showAddStatus(msg, classId) {
    $('#sidebar-add-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-add-status').addClass(classId);
    }
  }
  function showAddSheetStatus(msg, classId) {
    $('#sidebar-update-settings-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-update-settings-status').addClass(classId);
    }
  }
  function showRefreshStatus(msg, classId) {
    $('#sidebar-refresh-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-refresh-status').addClass(classId);
    }
  }
  function dropDownPopulate(id) {
    google.script.run
      .withSuccessHandler(  // Respond to success conditions here.
        function (sheetNameArray) {
          console.log("Entered withSuccessHandler dropDownPopulate");
          // Respond to success conditions here.
          dropdown = document.getElementById(id);
          for (var i = 0; i < sheetNameArray.length; i++) {
            var sheetName = sheetNameArray[i];
            existingOptions = dropdown.querySelectorAll("[value=" + sheetName + "]");
            if (existingOptions.length == 0) {
              var el = document.createElement("option");
              el.textContent = sheetName;
              el.value = sheetName;
              console.log("Dropdown length"+dropdown.options.length);
              if (dropdown.options.length == 0) {
                console.log("DropDown was empty, setting first element as "+ sheetName);
                el.selected = 'selected';
              }
              dropdown.appendChild(el);
            }
          }
        })
      .withFailureHandler(
        function (error) {
          // Respond to failure conditions here.
          alert('Problem during dropdown population');
        })
      .getNamesOfSheets();
  }
  function emailInfoVisibilityCheck() {
    check = document.getElementById('send-email-check');
    if (check.checked) {
      document.getElementById('email-info').style.display = 'inline';
    } else {
      document.getElementById('email-info').style.display = 'none';
    }
  }

  function getSettingsFromHTML() {
    var settings = {};

    datasheet = document.getElementById("data-sheet-dropdown");
    console.log("Data sheet dropdown options and value: "+datasheet.options+" "+datasheet.value);
    settings["datasheet"] = datasheet.value;
    // $datasheet = $('#data-sheet-dropdown');
    // console.log("Data sheet drowdown options: "+$datasheet.options);
    // settings["datasheet"] = $datasheet.value;

    pdfsheet = document.getElementById("pdf-sheet-dropdown");
    console.log("PDF sheet dropdown options and value: "+pdfsheet.options+" "+pdfsheet.value);
    settings["pdfsheet"] = pdfsheet.value;

    $pdfname = $('#sidebar-pdfname');
    settings["pdfname"] = $pdfname.val();

    $pdflastrow = $('#sidebar-pdflastrow');
    settings["pdflastrow"] = $pdflastrow.val();

    $pdflastcol = $('#sidebar-pdflastcol');
    settings["pdflastcol"] = $pdflastcol.val();

    settings["emailchecked"] = document.getElementById('send-email-check').checked;

    $emailcolumn = $('#sidebar-mail-column');
    settings["emailcolumn"] = $emailcolumn.val();

    $emailsendername = $('#email-sender-name');
    settings["emailsendername"] = $emailsendername.val();
    $emailsubject = $('#email-subject');
    settings["emailsubject"] = $emailsubject.val();
    $emailbody = $('#email-body');
    settings["emailbody"] = $emailbody.val();

    return settings;
  }
</script>